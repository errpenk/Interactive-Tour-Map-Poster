<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VELOCITY - 2025 Global Tour</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        :root {
            --main-blue: #005ac0;
            --main-black: #000000;
            --bg-white: #ffffff;
            --map-bg-gray: #f9f9f9; 
            --font-main: 'Inter', sans-serif;
            --font-tech: 'JetBrains Mono', monospace;
            --grid-line-color: #e0e0e0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: var(--font-main);
            padding: 20px;
        }

        /* MAIN CONTAINER */
        .poster-container {
            background-color: var(--bg-white);
            width: 100%;
            max-width: 700px;
            aspect-ratio: 3 / 4.6; 
            padding: 40px 40px 0 40px; 
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            color: var(--main-black);
            position: relative;
            overflow: hidden; 
        }

        /* --- BACKGROUND DECOR --- */
        .bg-supergraphic {
            position: absolute; top: -20px; left: -20px;
            font-size: 25rem; font-weight: 900;
            color: #f4f4f4; 
            z-index: 0; pointer-events: none;
            line-height: 1; letter-spacing: -0.05em;
        }

        .bg-stripes {
            position: absolute; top: 0; right: 0;
            width: 150px; height: 150px;
            background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 50%, #f0f0f0 50%, #f0f0f0 75%, transparent 75%, transparent);
            background-size: 10px 10px; z-index: 0;
        }

        .reg-mark {
            position: absolute; width: 10px; height: 10px;
            border: 1px solid var(--main-blue); border-radius: 50%;
            z-index: 2;
        }
        .reg-mark::after, .reg-mark::before { content: ''; position: absolute; background: var(--main-blue); }
        .reg-mark::after { top: 4px; left: -2px; width: 12px; height: 1px; }
        .reg-mark::before { top: -2px; left: 4px; width: 1px; height: 12px; }
        .rm-tl { top: 15px; left: 15px; }
        .rm-br { top: 50%; right: 15px; }

        .guide-lines {
            position: absolute; top: 0; left: 40px; right: 40px; bottom: 0;
            display: grid; grid-template-columns: 0.8fr 1fr 1fr; 
            z-index: 0; pointer-events: none;
        }
        .gl-col { border-right: 1px solid var(--grid-line-color); height: 100%; }
        .gl-col:first-child { border-left: 1px solid var(--grid-line-color); }

        /* --- CONTENT WRAPPER --- */
        .content-wrapper {
            position: relative; z-index: 1;
            display: flex; flex-direction: column; height: 100%;
        }

        /* --- HEADER --- */
        .header-bar {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 30px; border-bottom: 4px solid var(--main-black);
            padding-bottom: 20px; position: relative;
        }
        .band-info { display: flex; flex-direction: column; }
        .band-name {
            font-weight: 900; text-transform: uppercase; font-size: 2.2rem;
            letter-spacing: -0.05em; line-height: 0.9; margin-bottom: 10px;
        }
        .tour-meta { display: flex; gap: 15px; align-items: center; }
        .tour-subtitle {
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
            color: var(--main-black); line-height: 1.2; letter-spacing: 0.02em;
        }
        .barcode {
            height: 20px; width: 60px;
            background: repeating-linear-gradient(
                to right,
                var(--main-black) 0px, var(--main-black) 1px,
                transparent 1px, transparent 3px,
                var(--main-black) 3px, var(--main-black) 4px,
                transparent 4px, transparent 6px
            );
        }
        .year-square {
            background-color: var(--main-blue); color: white;
            font-weight: 800; font-size: 1.8rem; line-height: 1;
            letter-spacing: -0.05em; padding: 12px;
            display: flex; gap: 2px; box-shadow: 4px 4px 0 #eee;
        }

        /* --- TITLE --- */
        .title-container { margin-bottom: 30px; position: relative; }
        .main-title {
            font-weight: 900; font-size: clamp(3.5rem, 11vw, 7rem); 
            line-height: 0.8; text-transform: uppercase; letter-spacing: -0.06em;
            display: flex; flex-direction: column;
        }
        .title-deco-line {
            width: 100px; height: 2px; background: var(--main-blue); margin-top: 10px;
        }
        .text-blue { color: var(--main-blue); }

        /* --- GRID --- */
        .swiss-grid {
            display: grid; grid-template-columns: 0.8fr 1fr 1fr; 
            border-top: 1px solid var(--main-black);
            border-bottom: 1px solid var(--main-black);
            margin-bottom: 0; 
        }
        .grid-col {
            display: flex; flex-direction: column; padding: 20px 10px 20px 0; position: relative;
        }
        .grid-col:nth-child(2), .grid-col:nth-child(3) { padding-left: 15px; }
        .grid-col.right-align { align-items: flex-end; text-align: right; }
        .grid-col.right-align li { flex-direction: row-reverse; }

        .col-header {
            width: 100%; font-weight: 800; text-transform: uppercase;
            font-size: 0.7rem; margin-bottom: 15px; color: var(--main-black);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee; padding-bottom: 5px;
        }
        .col-idx {
            background: var(--main-black); color: white;
            padding: 2px 5px; font-size: 0.6rem; font-family: monospace;
        }
        .col-body {
            font-size: 0.7rem; font-weight: 600; line-height: 1.6;
            text-transform: uppercase; color: #333;
        }
        .meta-data {
            font-size: 0.55rem; color: #666; margin-top: auto; padding-top: 15px;
            font-weight: 600; font-family: 'Inter', monospace;
            display: flex; flex-direction: column; gap: 2px;
        }
        .meta-label { color: var(--main-blue); }
        ul { list-style: none; }
        li { margin-bottom: 4px; display: flex; gap: 10px; align-items: center; }
        .date-num { font-weight: 800; color: var(--main-blue); min-width: 18px; }

        /* --- MAP AREA --- */
        .artwork-area {
            flex-grow: 1;
            width: calc(100% + 80px); margin-left: -40px; margin-right: -40px;
            background-color: var(--map-bg-gray);
            position: relative; overflow: hidden; min-height: 380px; border-top: none;
        }

        #map {
            width: 100%; height: 100%; z-index: 1;
            background-color: var(--map-bg-gray);
        }

        /* --- MAP OVERLAY DECORATIONS --- */
        .map-overlay-internal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 500; /* Above Italy(400) */
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        /* Helper class to hide immediately */
        .map-overlay-internal.hidden {
            opacity: 0;
            transition: none; /* Instant hide */
        }

        .map-grid-lines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(var(--grid-line-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line-color) 1px, transparent 1px);
            background-size: 40px 40px; opacity: 0.6;
        }

        .map-radar {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            border: 1px solid rgba(0, 90, 192, 0.15);
            border-radius: 50%;
        }
        .map-radar::before {
            content: ''; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 60%; height: 60%;
            border: 1px dashed rgba(0, 90, 192, 0.3); border-radius: 50%;
        }

        .map-bracket {
            position: absolute; width: 20px; height: 20px;
            border: 2px solid var(--main-black);
        }
        .mb-tl { top: 15px; left: 15px; border-right: none; border-bottom: none; }
        .mb-tr { top: 15px; right: 15px; border-left: none; border-bottom: none; }
        .mb-bl { bottom: 15px; left: 15px; border-right: none; border-top: none; }
        .mb-br { bottom: 15px; right: 15px; border-left: none; border-top: none; }

        .map-vertical-text {
            position: absolute; top: 30%; bottom: 30%; left: 12px;
            writing-mode: vertical-rl; text-orientation: mixed;
            font-family: var(--font-tech); font-size: 0.5rem;
            color: #555; letter-spacing: 0.15em;
            border-left: 1px solid #ccc; padding-left: 4px;
            display: flex; align-items: center; justify-content: space-between;
            text-transform: uppercase;
        }

        .map-top-scale {
            position: absolute; top: 0; left: 40px; right: 40px; height: 10px;
            border-bottom: 1px solid var(--main-black);
            display: flex; justify-content: space-between;
        }
        .scale-tick { width: 1px; height: 4px; background: var(--main-black); margin-top: 6px; }
        .scale-num { position: absolute; top: 12px; font-family: var(--font-tech); font-size: 0.5rem; color: #666; }

        .map-ruler {
            position: absolute; bottom: 15px; left: 15px; right: 15px; height: 20px;
            border-top: 1px solid var(--main-blue);
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .ruler-dash { width: 1px; height: 5px; background: var(--main-blue); }
        .ruler-dash.long { height: 10px; }

        .map-label {
            position: absolute; font-family: var(--font-tech);
            font-size: 0.5rem; font-weight: 700;
            color: var(--main-black); background: white; padding: 1px 4px;
            border: 1px solid #ccc; box-shadow: 2px 2px 0 rgba(0,0,0,0.05);
        }
        .ml-1 { top: 20px; left: 50px; }
        .ml-2 { bottom: 40px; right: 50px; border-color: var(--main-blue); color: var(--main-blue); }

        /* --- MODERN UI --- */
        .map-ui-modern {
            position: absolute; top: 25px; right: 25px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: auto;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px); border: 1px solid var(--main-black);
            padding: 12px; width: 130px; box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
        }

        .panel-header {
            font-family: var(--font-tech); font-size: 0.5rem; color: #666;
            text-transform: uppercase; letter-spacing: 0.05em;
            border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 8px;
            display: flex; justify-content: space-between;
        }
        .status-light { width: 6px; height: 6px; background: #00ff00; border-radius: 50%; animation: blink 2s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .zoom-track {
            height: 10px; background: #eee; width: 100%;
            position: relative; margin: 5px 0; cursor: pointer;
        }
        .zoom-track::before { content: ''; position: absolute; top: 4px; left: 0; width: 100%; height: 2px; background: #ccc; }
        .zoom-progress {
            height: 2px; background: var(--main-blue); width: 0%;
            position: absolute; top: 4px; left: 0; pointer-events: none;
            transition: width 0.3s;
        }
        .zoom-knob {
            width: 6px; height: 14px; background: var(--main-black);
            position: absolute; top: -2px; transform: translateX(-50%); pointer-events: none;
            transition: left 0.3s;
        }
        .zoom-value {
            font-family: var(--font-tech); font-size: 0.7rem; font-weight: 700;
            color: var(--main-blue); text-align: right; margin-top: 2px;
        }

        .btn-tech {
            background: var(--main-black); color: white; border: none;
            font-family: var(--font-tech); font-size: 0.6rem;
            padding: 8px 10px; cursor: pointer; text-transform: uppercase;
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.2s; box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }
        .btn-tech:hover { background: var(--main-blue); box-shadow: 1px 1px 0 rgba(0,0,0,0.1); transform: translate(1px, 1px); }

        /* --- MARKERS --- */
        .leaflet-tile-pane { mix-blend-mode: multiply; filter: grayscale(100%) contrast(115%); }
        .leaflet-overlay-pane { mix-blend-mode: multiply; opacity: 0.9; }
        .leaflet-marker-pane { filter: none; z-index: 600; }

        .custom-icon {
            background-color: var(--main-blue); border: 2px solid #fff; 
            border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3); 
            cursor: pointer; transition: transform 0.3s, opacity 0.3s;
        }
        .custom-icon:not(.dimmed):hover { transform: scale(1.4); background-color: #fff; border-color: var(--main-blue); z-index: 1000; }
        .custom-icon.selected { transform: scale(1.8); background-color: var(--main-blue); border-color: #fff; z-index: 2000 !important; }
        .custom-icon.dimmed { transform: scale(0.6); opacity: 0.5; background-color: #999; }

        .artwork-area::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.3'/%3E%3C/svg%3E");
            mix-blend-mode: multiply; pointer-events: none; z-index: 10;
        }
        
        .leaflet-popup-content-wrapper { border-radius: 0; font-family: var(--font-tech); background: white; border: 1px solid var(--main-blue); }
        .leaflet-popup-content { font-size: 0.7rem; margin: 8px 10px; }
        .leaflet-popup-tip { background: var(--main-blue); }
        
        @media (max-width: 500px) {
            .swiss-grid { grid-template-columns: 1fr; border-bottom: none; }
            .guide-lines { display: none; }
            .grid-col { border-right: none; border-bottom: 1px solid #000; }
            .grid-col.right-align { align-items: flex-start; text-align: left; }
            .grid-col.right-align li { flex-direction: row; }
            .main-title { font-size: 15vw; }
            .bg-supergraphic { display: none; }
        }

    </style>
</head>
<body>

    <div class="poster-container">
        
        <div class="bg-supergraphic">04</div>
        <div class="bg-stripes"></div>
        <div class="guide-lines">
            <div class="gl-col"></div><div class="gl-col"></div><div class="gl-col"></div>
        </div>
        <div class="reg-mark rm-tl"></div><div class="reg-mark rm-br"></div>

        <div class="content-wrapper">
            
            <div class="header-bar">
                <div class="band-info">
                    <div class="band-name">Velocity</div>
                    <div class="tour-meta">
                        <div class="tour-subtitle">Live<br>Series 04</div>
                        <div class="barcode"></div>
                    </div>
                </div>
                <div class="year-square"><span>20</span><span>25</span></div>
            </div>

            <div class="title-container">
                <div class="main-title">
                    <span class="text-blue">Italy</span><span>Tour</span>
                </div>
                <div class="title-deco-line"></div>
            </div>

            <div class="swiss-grid">
                <div class="grid-col">
                    <!-- TARGET 1: SYSTEM -> INTRO -->
                    <div class="col-header"><span>Intro</span><span class="col-idx">01</span></div>
                    <div class="col-body">
                        <p style="margin-bottom: 8px;">New Tracks +<br>Archival Classics.</p>
                        <p>Velocity Mgmt.</p>
                    </div>
                    <div class="meta-data">
                        <span>DUR: 120M</span><span>TYPE: GEN/ADM</span><span class="meta-label">STATUS: CONFIRMED</span>
                    </div>
                </div>
                <div class="grid-col right-align">
                    <div class="col-header"><span class="col-idx">02</span><span>Nov</span></div>
                    <ul class="col-body">
                        <li><span class="date-num">03</span> <span>Milan</span></li>
                        <li><span class="date-num">05</span> <span>Turin</span></li>
                        <li><span class="date-num">07</span> <span>Bologna</span></li>
                        <li><span class="date-num">08</span> <span>Florence</span></li>
                        <li><span class="date-num">10</span> <span>Rome</span></li>
                        <li><span class="date-num">12</span> <span>Naples</span></li>
                    </ul>
                </div>
                <div class="grid-col right-align">
                    <div class="col-header"><span class="col-idx">03</span><span>Dec</span></div>
                    <ul class="col-body">
                        <li><span class="date-num">01</span> <span>Bari</span></li>
                        <li><span class="date-num">03</span> <span>Palermo</span></li>
                        <li><span class="date-num">04</span> <span>Catania</span></li>
                        <li><span class="date-num">08</span> <span>Padua</span></li>
                        <li><span class="date-num">10</span> <span>Venice</span></li>
                        <li><span class="date-num">12</span> <span>Trieste</span></li>
                        <li><span class="date-num">14</span> <span>Verona</span></li>
                    </ul>
                </div>
            </div>

            <div class="artwork-area">
                <div class="map-ui-modern">
                    <div class="control-panel">
                        <!-- TARGET 3: Sys Zoom -> Zoom In -->
                        <div class="panel-header"><span>Zoom In</span><div class="status-light"></div></div>
                        <div class="zoom-value" id="zoom-text">1x</div>
                        <div class="zoom-track" id="zoom-track">
                            <div class="zoom-progress" id="zoom-fill"></div>
                            <div class="zoom-knob" id="zoom-knob"></div>
                        </div>
                    </div>
                    <button class="btn-tech" id="reset-btn">Rest. View</button>
                </div>

                <div id="map"></div>
                
                <div id="map-decorations-source" style="display:none;">
                    <div class="map-overlay-internal">
                        <div class="map-grid-lines"></div>
                        <div class="map-radar"></div>
                        <div class="map-bracket mb-tl"></div>
                        <div class="map-bracket mb-tr"></div>
                        <div class="map-bracket mb-bl"></div>
                        <div class="map-bracket mb-br"></div>
                        
                        <!-- TARGET 2: SYSTEM_04 -> SERIES_04 -->
                        <div class="map-vertical-text">
                             <span>SERIES_04</span><span>//</span><span>VELOCITY</span>
                        </div>

                        <div class="map-top-scale">
                            <div class="scale-tick"></div><div class="scale-tick"></div><div class="scale-tick"></div>
                            <div class="scale-num" style="left:0">010</div>
                            <div class="scale-num" style="left:50%">020</div>
                            <div class="scale-num" style="right:0">030</div>
                        </div>

                        <div class="map-ruler">
                            <div class="ruler-dash long"></div><div class="ruler-dash"></div><div class="ruler-dash"></div>
                            <div class="ruler-dash long"></div><div class="ruler-dash"></div><div class="ruler-dash"></div>
                            <div class="ruler-dash long"></div>
                        </div>

                        <div class="map-label ml-1">+ 45.00</div>
                        <div class="map-label ml-2">DATA_LINK: ACTIVE</div>
                    </div>
                </div>
            </div>

        </div> 
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        const ITALY_CENTER = [42.50, 12.5];
        const MIN_ZOOM = 5;
        const MAX_ZOOM = 9;
        const ITALY_BOUNDS = [[35.0, 5.5], [48.0, 19.0]];

        const map = L.map('map', {
            center: ITALY_CENTER,
            zoom: MIN_ZOOM,
            minZoom: MIN_ZOOM,
            maxZoom: MAX_ZOOM,
            maxBounds: ITALY_BOUNDS,
            maxBoundsViscosity: 1.0,
            zoomControl: false, attributionControl: false, scrollWheelZoom: true
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            maxZoom: 19, subdomains: 'abcd'
        }).addTo(map);

        // Inject Decorations
        const decorSource = document.getElementById('map-decorations-source');
        const mapContainer = document.getElementById('map');
        const decorClone = decorSource.firstElementChild.cloneNode(true);
        mapContainer.appendChild(decorClone);
        
        // Zoom Animation Logic for Decorations
        const overlay = mapContainer.querySelector('.map-overlay-internal');
        map.on('zoomstart', () => {
            overlay.classList.add('hidden');
        });
        map.on('zoomend', () => {
            overlay.classList.remove('hidden');
        });

        fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries/ITA.geo.json')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: function (feature) {
                        return { color: '#005ac0', weight: 1, fillColor: '#005ac0', fillOpacity: 0.1 };
                    },
                    interactive: false 
                }).addTo(map);
            })
            .catch(err => console.error("Error loading Italy GeoJSON:", err));

        // Updated tourStops with Date Info
        const tourStops = [
            { city: "MILAN", venue: "ALCATRAZ", date: "NOV 03", coords: [45.4642, 9.1900] },
            { city: "TURIN", venue: "HIROSHIMA MON AMOUR", date: "NOV 05", coords: [45.0703, 7.6869] },
            { city: "BOLOGNA", venue: "ESTRAGON", date: "NOV 07", coords: [44.4949, 11.3426] },
            { city: "FLORENCE", venue: "VIPER THEATRE", date: "NOV 08", coords: [43.7696, 11.2558] },
            { city: "ROME", venue: "ATLANTICO", date: "NOV 10", coords: [41.9028, 12.4964] },
            { city: "NAPLES", venue: "CASA DELLA MUSICA", date: "NOV 12", coords: [40.8518, 14.2681] },
            { city: "BARI", venue: "DEMODE CLUB", date: "DEC 01", coords: [41.1171, 16.8719] },
            { city: "PALERMO", venue: "I CANDELAI", date: "DEC 03", coords: [38.1157, 13.3615] },
            { city: "CATANIA", venue: "LAND", date: "DEC 04", coords: [37.5079, 15.0830] },
            { city: "PADUA", venue: "HALL", date: "DEC 08", coords: [45.4064, 11.8768] },
            { city: "VENICE", venue: "NEW AGE", date: "DEC 10", coords: [45.4408, 12.3155] },
            { city: "TRIESTE", venue: "TEATRO MIELA", date: "DEC 12", coords: [45.6495, 13.7768] },
            { city: "VERONA", venue: "THE FACTORY", date: "DEC 14", coords: [45.4384, 10.9916] }
        ];

        const customIcon = L.divIcon({
            className: 'custom-icon', iconSize: [16, 16], iconAnchor: [8, 8], popupAnchor: [0, -10]
        });

        let allMarkers = [];

        tourStops.forEach(stop => {
            const marker = L.marker(stop.coords, { icon: customIcon }).addTo(map);
            allMarkers.push(marker);
            // Popup includes the DATE now
            marker.bindPopup(`
                <div style="font-size: 0.8rem; font-weight:700; color:#666; margin-bottom:2px;">${stop.date}</div>
                <div style="color: #005ac0; font-size: 1rem;">${stop.city}</div>
                <div>${stop.venue}</div>
            `);
            marker.on('mouseover', function (e) { this.openPopup(); });
            marker.on('click', function (e) { 
                this.openPopup();
                e.originalEvent.stopPropagation(); 
                allMarkers.forEach(m => {
                    const iconEl = m.getElement();
                    if (m === marker) {
                        if (iconEl) { iconEl.classList.add('selected'); iconEl.classList.remove('dimmed'); }
                    } else {
                        if (iconEl) { iconEl.classList.add('dimmed'); iconEl.classList.remove('selected'); }
                    }
                });
            });
        });

        const fillBar = document.getElementById('zoom-fill');
        const zoomKnob = document.getElementById('zoom-knob');
        const zoomText = document.getElementById('zoom-text');
        const zoomTrack = document.getElementById('zoom-track');
        const resetBtn = document.getElementById('reset-btn');

        function updateUI() {
            const currentZoom = map.getZoom();
            const range = MAX_ZOOM - MIN_ZOOM;
            const val = currentZoom - MIN_ZOOM;
            const percent = (val / range) * 100;
            fillBar.style.width = `${percent}%`;
            zoomKnob.style.left = `${percent}%`;
            zoomText.innerText = `${val + 1}x`;
        }

        function resetMarkerState() {
            allMarkers.forEach(m => {
                const iconEl = m.getElement();
                if (iconEl) { iconEl.classList.remove('selected'); iconEl.classList.remove('dimmed'); }
                m.closePopup();
            });
        }

        zoomTrack.addEventListener('click', function(e) {
            const rect = zoomTrack.getBoundingClientRect();
            const percent = Math.min(1, Math.max(0, (e.clientX - rect.left) / rect.width));
            const newZoom = Math.round(MIN_ZOOM + ((MAX_ZOOM - MIN_ZOOM) * percent));
            map.setZoom(newZoom);
        });

        map.on('zoomend', updateUI);
        map.on('click', () => { resetMarkerState(); });
        resetBtn.addEventListener('click', () => { map.setView(ITALY_CENTER, MIN_ZOOM); resetMarkerState(); });

        updateUI();
    </script>
</body>
</html>